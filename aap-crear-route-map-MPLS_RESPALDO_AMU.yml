---
- name: Crear route-map MPLS_RESPALDO_AMU
  hosts: all
  gather_facts: no

  vars:
    route_map_name: ""
    bgp_as_number: "65021"
    vrf_name: ""
    neighbor_ip: ""
    as_path_prepend: "{{ bgp_as_number }}"  # Asegura que as_path_prepend sea igual a bgp_as_number

  tasks:
    - name: Validar que la VRF exista
      arista.eos.eos_command:
        commands:
          - show vrf
      register: vrf_check

    - name: Verificar existencia de la VRF
      fail:
        msg: "La VRF {{ vrf_name }} no existe."
      when: "'{{ vrf_name }}' not in vrf_check.stdout"

    - name: Validar que el route-map no exista
      arista.eos.eos_command:
        commands:
          - show running-config | section route-map
      register: route_map_check

    - name: Verificar inexistencia del route-map
      fail:
        msg: "El route-map {{ route_map_name }} ya existe."
      when: "'route-map {{ route_map_name }} ' in route_map_check.stdout"

    - name: Configurar route-map
      arista.eos.eos_command:
        commands:
          - configure terminal
          - route-map {{ route_map_name }} permit 10
          - set as-path prepend {{ as_path_prepend }}
      register: route_map_config
      changed_when: "'Invalid input' not in route_map_config.stdout"

    - name: Debug Configurar route-map
      debug:
        msg: "Resultado de la configuración del route-map: {{ route_map_config }}"

    - name: Configurar BGP
      arista.eos.eos_command:
        commands:
          - configure terminal
          - router bgp {{ bgp_as_number }}
          - vrf {{ vrf_name }}
          - neighbor {{ neighbor_ip }} route-map {{ route_map_name }} out
      register: bgp_config
      changed_when: "'Invalid input' not in bgp_config.stdout"

    - name: Debug Configurar BGP
      debug:
        msg: "Resultado de la configuración de BGP: {{ bgp_config }}"

    - name: Guardar cambios
      arista.eos.eos_command:
        commands:
          - write memory
      register: save_config

    - name: Debug Guardar cambios
      debug:
        msg: "Resultado de guardar cambios: {{ save_config }}"
